name: Rebuild postliste.json

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rebuild:
    runs-on: ubuntu-latest

    steps:
      - name: Sjekk ut repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Sett opp Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Installer avhengigheter
        run: |
          python -m pip install --upgrade pip

      - name: Kombiner og valider H1 + H2
        run: |
          python - << 'EOF'
          import json, os
          from datetime import datetime

          h1 = "data/archive/postliste_2006_H1.json"
          h2 = "data/archive/postliste_2006_H2.json"
          out = "data/postliste.json"

          def load(path):
            if not os.path.exists(path):
              print(f"[WARN] Mangler: {path}")
              return []
            try:
              with open(path, "r", encoding="utf-8") as f:
                data = json.load(f)
                if isinstance(data, list):
                  return data
                print(f"[WARN] {path} er ikke en liste")
                return []
            except Exception as e:
              print(f"[ERROR] Kunne ikke lese {path}: {e}")
              return []

          print("[INFO] Leser H1 og H2...")
          data_h1 = load(h1)
          data_h2 = load(h2)

          combined = data_h1 + data_h2

          print(f"[INFO] Kombinert antall: {len(combined)}")

          # Fjern duplikater basert på dokumentID
          unique = {}
          for d in combined:
            docid = d.get("dokumentID")
            if docid:
              unique[docid] = d

          print(f"[INFO] Unike oppføringer: {len(unique)}")

          # Sorter etter dato (dd.mm.yyyy)
          def sort_key(x):
            try:
              return datetime.strptime(x.get("dato"), "%d.%m.%Y")
            except:
              return datetime.min

          sorted_list = sorted(unique.values(), key=sort_key, reverse=True)

          # Lagre
          with open(out, "w", encoding="utf-8") as f:
            json.dump(sorted_list, f, ensure_ascii=False, indent=2)

          print(f"[INFO] Lagret {len(sorted_list)} oppføringer til {out}")
          EOF

      - name: Sett opp git remote
        run: |
          git remote remove origin || true
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Commit og push
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git add data/postliste.json
          git commit -m "Regenerert postliste.json fra H1 + H2" || echo "Ingen endringer å committe"
          git pull --rebase origin main || echo "Ingen endringer å hente"
          git push origin main
