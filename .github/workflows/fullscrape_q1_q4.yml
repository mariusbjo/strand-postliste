name: Full historical scrape (Q1–Q4)

on:
  workflow_dispatch:
    inputs:
      year:
        description: "Årstall for fullscrape (f.eks. 2013)"
        required: true
        type: string

      start_page:
        description: "Start page (eldste side for året)"
        required: true
        type: string

      max_pages:
        description: "Max page (nyeste side for året)"
        required: true
        type: string

permissions:
  contents: write

# EGEN concurrency-gruppe slik at fullscrape IKKE står i kø
concurrency:
  group: fullscrape-${{ github.ref }}
  cancel-in-progress: false

jobs:

  # -------------------------
  # Felles setup for alle kvartaler
  # -------------------------
  setup:
    runs-on: ubuntu-latest
    outputs:
      year: ${{ github.event.inputs.year }}
      start_page: ${{ github.event.inputs.start_page }}
      max_pages: ${{ github.event.inputs.max_pages }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-v1

      - name: Installer Playwright + dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright beautifulsoup4
          playwright install chromium

      - name: Skriv config_fullscrape.json
        run: |
          mkdir -p src/config
          cat <<EOF > src/config/config_fullscrape.json
          {
            "start_page": ${{ github.event.inputs.start_page }},
            "max_pages": ${{ github.event.inputs.max_pages }},
            "per_page": 100
          }
          EOF

  # -------------------------
  # Q1 SCRAPE
  # -------------------------
  scrape_Q1:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-v1

      - name: Kjør Q1-scrape
        working-directory: src/scrapers
        run: |
          python scraper_dates.py \
            --mode full \
            --config ../config/config_fullscrape.json \
            "01.01.${{ needs.setup.outputs.year }}" \
            "31.03.${{ needs.setup.outputs.year }}"

      - name: Last opp artifact Q1
        uses: actions/upload-artifact@v4
        with:
          name: fullscrape-Q1
          path: data/postliste_filtered.json

  # -------------------------
  # Q2 SCRAPE
  # -------------------------
  scrape_Q2:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-v1

      - name: Kjør Q2-scrape
        working-directory: src/scrapers
        run: |
          python scraper_dates.py \
            --mode full \
            --config ../config/config_fullscrape.json \
            "01.04.${{ needs.setup.outputs.year }}" \
            "30.06.${{ needs.setup.outputs.year }}"

      - name: Last opp artifact Q2
        uses: actions/upload-artifact@v4
        with:
          name: fullscrape-Q2
          path: data/postliste_filtered.json

  # -------------------------
  # Q3 SCRAPE
  # -------------------------
  scrape_Q3:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-v1

      - name: Kjør Q3-scrape
        working-directory: src/scrapers
        run: |
          python scraper_dates.py \
            --mode full \
            --config ../config/config_fullscrape.json \
            "01.07.${{ needs.setup.outputs.year }}" \
            "30.09.${{ needs.setup.outputs.year }}"

      - name: Last opp artifact Q3
        uses: actions/upload-artifact@v4
        with:
          name: fullscrape-Q3
          path: data/postliste_filtered.json

  # -------------------------
  # Q4 SCRAPE
  # -------------------------
  scrape_Q4:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-v1

      - name: Kjør Q4-scrape
        working-directory: src/scrapers
        run: |
          python scraper_dates.py \
            --mode full \
            --config ../config/config_fullscrape.json \
            "01.10.${{ needs.setup.outputs.year }}" \
            "31.12.${{ needs.setup.outputs.year }}"

      - name: Last opp artifact Q4
        uses: actions/upload-artifact@v4
        with:
          name: fullscrape-Q4
          path: data/postliste_filtered.json

  # -------------------------
  # MERGE & COMMIT
  # -------------------------
  merge_and_commit:
    runs-on: ubuntu-latest
    needs: [scrape_Q1, scrape_Q2, scrape_Q3, scrape_Q4]

    steps:
      - uses: actions/checkout@v4

      - name: Last ned artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Arkiver alle kvartaler
        run: |
          mkdir -p data/archive
          cp artifacts/fullscrape-Q1/postliste_filtered.json data/archive/postliste_${{ github.event.inputs.year }}_Q1.json
          cp artifacts/fullscrape-Q2/postliste_filtered.json data/archive/postliste_${{ github.event.inputs.year }}_Q2.json
          cp artifacts/fullscrape-Q3/postliste_filtered.json data/archive/postliste_${{ github.event.inputs.year }}_Q3.json
          cp artifacts/fullscrape-Q4/postliste_filtered.json data/archive/postliste_${{ github.event.inputs.year }}_Q4.json

      - name: Commit og push
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

          git add data/archive/postliste_${{ github.event.inputs.year }}_Q*.json
          git commit -m "Fullscrape ${{ github.event.inputs.year }} (Q1–Q4)" || echo "Ingen endringer"

          git pull --rebase origin main || true
          git push origin main || true

  merge_full_year:
    runs-on: ubuntu-latest
    needs: merge_and_commit

    steps:
      - uses: actions/checkout@v4

      - name: Last ned kvartalsfiler
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Slå sammen kvartaler til én fil
        run: |
          YEAR="${{ github.event.inputs.year }}"
          mkdir -p data/archive

          # Slå sammen alle kvartaler
          jq -s 'add' \
            artifacts/fullscrape-Q1/postliste_filtered.json \
            artifacts/fullscrape-Q2/postliste_filtered.json \
            artifacts/fullscrape-Q3/postliste_filtered.json \
            artifacts/fullscrape-Q4/postliste_filtered.json \
            > data/archive/postliste_${YEAR}_full_unsorted.json

          # Sorter etter dato (eldst → nyest)
          jq 'sort_by(.dato)' \
            data/archive/postliste_${YEAR}_full_unsorted.json \
            > data/archive/postliste_${YEAR}_full.json

          rm data/archive/postliste_${YEAR}_full_unsorted.json

      - name: Commit og push full-årsfil
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

          git add data/archive/postliste_${{ github.event.inputs.year }}_full.json
          git commit -m "Fullscrape ${{ github.event.inputs.year }} – samlet årsfil" || echo "Ingen endringer"

          git pull --rebase origin main || true
          git push origin main || true
